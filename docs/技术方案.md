# 教育类微信小程序技术方案文档

## 技术架构概览

### 系统架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微信小程序端    │    │    后端API服务   │    │   PC管理后台     │
│   (学生端)      │◄──►│                │◄──►│   (老师端)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   数据库+存储    │
                       └─────────────────┘
```

## 技术选型

### 前端技术栈

#### 微信小程序端
- **框架**：微信小程序原生开发
- **UI组件库**：WeUI / Vant Weapp
- **状态管理**：小程序全局状态 + 本地存储
- **网络请求**：wx.request()
- **媒体播放**：wx.createVideoContext()

#### PC管理后台
- **框架**：Vue 3 + TypeScript
- **UI组件库**：Element Plus
- **构建工具**：Vite
- **路由管理**：Vue Router
- **状态管理**：Pinia
- **HTTP客户端**：Axios
- **文件上传**：Element Plus Upload组件

### 后端技术栈
- **运行环境**：Node.js 18+
- **Web框架**：NestJS (TypeScript)
- **数据库**：MySQL 8.0
- **ORM框架**：Prisma
- **身份认证**：JWT + Passport
- **文件存储**：本地存储 + 七牛云/阿里云OSS
- **接口文档**：Swagger (自动生成)
- **数据验证**：class-validator + class-transformer

### 数据库设计

#### Prisma Schema 设计
```prisma
// 用户表
model User {
  id        Int      @id @default(autoincrement())
  openid    String   @unique
  nickname  String?
  avatar    String?
  role      String   @default("student")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // 关联关系
  learningRecords LearningRecord[]
  
  @@map("users")
}

// 题目表
model Question {
  id          Int      @id @default(autoincrement())
  title       String
  content     String   @db.Text
  type        String   // single, multiple, fill, essay
  options     Json?    // 选择题选项
  answer      String   @db.Text
  explanation String?  @db.Text
  category    String
  difficulty  String   @default("medium")
  imageUrl    String?  @map("image_url")
  videoUrl    String?  @map("video_url")      // 题目讲解视频URL
  videoDuration Int?   @map("video_duration") // 视频时长（秒）
  createdAt   DateTime @default(now()) @map("created_at")
  
  // 关联关系
  learningRecords LearningRecord[]
  
  @@map("questions")
}

// 视频表
model Video {
  id           Int      @id @default(autoincrement())
  title        String
  description  String?  @db.Text
  fileUrl      String   @map("file_url")
  duration     Int?     // 秒数
  category     String
  thumbnailUrl String?  @map("thumbnail_url")
  fileSize     BigInt?  @map("file_size")
  createdAt    DateTime @default(now()) @map("created_at")
  
  // 关联关系
  learningRecords LearningRecord[]
  
  @@map("videos")
}

// 学习记录表
model LearningRecord {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  contentId   Int       @map("content_id")
  contentType String    @map("content_type") // question, video
  progress    Float     @default(0) // 0-100
  score       Int?      // 答题得分
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  
  // 关联关系
  user     User      @relation(fields: [userId], references: [id])
  question Question? @relation(fields: [contentId], references: [id])
  video    Video?    @relation(fields: [contentId], references: [id])
  
  @@map("learning_records")
}

// 管理员表
model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  email     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("admins")
}
```

## 项目目录结构

```
education-miniprogram/
├── miniprogram/                    # 微信小程序端
│   ├── pages/                     # 页面目录
│   │   ├── index/                 # 首页
│   │   ├── questions/             # 题目相关页面
│   │   │   ├── list/              # 题目列表
│   │   │   ├── detail/            # 题目详情
│   │   │   └── record/            # 练习记录
│   │   ├── videos/                # 视频相关页面
│   │   │   ├── list/              # 视频列表
│   │   │   ├── player/            # 视频播放
│   │   │   └── record/            # 学习记录
│   │   └── profile/               # 个人中心
│   ├── components/                # 公共组件
│   │   ├── question-item/         # 题目组件
│   │   ├── video-item/            # 视频组件
│   │   └── loading/               # 加载组件
│   ├── utils/                     # 工具函数
│   │   ├── request.js             # 网络请求封装
│   │   ├── storage.js             # 本地存储封装
│   │   └── common.js              # 通用工具函数
│   ├── styles/                    # 样式文件
│   ├── app.js                     # 小程序入口
│   ├── app.json                   # 小程序配置
│   └── app.wxss                   # 全局样式
├── admin-web/                     # PC管理后台
│   ├── src/
│   │   ├── views/                 # 页面组件
│   │   │   ├── login/             # 登录页
│   │   │   ├── dashboard/         # 控制台
│   │   │   ├── questions/         # 题目管理
│   │   │   │   ├── list.vue       # 题目列表
│   │   │   │   ├── add.vue        # 添加题目
│   │   │   │   └── edit.vue       # 编辑题目
│   │   │   ├── videos/            # 视频管理
│   │   │   │   ├── list.vue       # 视频列表
│   │   │   │   ├── upload.vue     # 上传视频
│   │   │   │   └── edit.vue       # 编辑视频
│   │   │   ├── statistics/        # 数据统计
│   │   │   └── settings/          # 个人设置
│   │   ├── components/            # 公共组件
│   │   │   ├── Layout/            # 布局组件
│   │   │   ├── Upload/            # 上传组件
│   │   │   └── Charts/            # 图表组件
│   │   ├── api/                   # API接口
│   │   ├── utils/                 # 工具函数
│   │   ├── router/                # 路由配置
│   │   ├── stores/                # 状态管理
│   │   ├── styles/                # 样式文件
│   │   ├── App.vue                # 根组件
│   │   └── main.ts                # 入口文件
│   ├── public/                    # 静态资源
│   ├── package.json
│   ├── vite.config.ts
│   └── tsconfig.json
├── server/                        # 后端服务 (NestJS)
│   ├── src/
│   │   ├── modules/               # 功能模块
│   │   │   ├── auth/              # 认证模块
│   │   │   │   ├── auth.controller.ts
│   │   │   │   ├── auth.service.ts
│   │   │   │   ├── auth.module.ts
│   │   │   │   ├── dto/           # 数据传输对象
│   │   │   │   └── guards/        # 守卫
│   │   │   ├── questions/         # 题目模块
│   │   │   │   ├── questions.controller.ts
│   │   │   │   ├── questions.service.ts
│   │   │   │   ├── questions.module.ts
│   │   │   │   └── dto/
│   │   │   ├── videos/            # 视频模块
│   │   │   │   ├── videos.controller.ts
│   │   │   │   ├── videos.service.ts
│   │   │   │   ├── videos.module.ts
│   │   │   │   └── dto/
│   │   │   ├── users/             # 用户模块
│   │   │   │   ├── users.controller.ts
│   │   │   │   ├── users.service.ts
│   │   │   │   ├── users.module.ts
│   │   │   │   └── dto/
│   │   │   └── statistics/        # 统计模块
│   │   │       ├── statistics.controller.ts
│   │   │       ├── statistics.service.ts
│   │   │       ├── statistics.module.ts
│   │   │       └── dto/
│   │   ├── common/                # 公共模块
│   │   │   ├── decorators/        # 装饰器
│   │   │   ├── filters/           # 异常过滤器
│   │   │   ├── guards/            # 全局守卫
│   │   │   ├── interceptors/      # 拦截器
│   │   │   └── pipes/             # 管道
│   │   ├── config/                # 配置
│   │   │   ├── database.config.ts
│   │   │   └── app.config.ts
│   │   ├── prisma/                # Prisma相关
│   │   │   ├── schema.prisma      # 数据库模式
│   │   │   └── prisma.service.ts  # Prisma服务
│   │   ├── app.controller.ts      # 应用控制器
│   │   ├── app.service.ts         # 应用服务
│   │   ├── app.module.ts          # 应用模块
│   │   └── main.ts                # 应用入口
│   ├── uploads/                   # 上传文件存储
│   ├── package.json
│   ├── tsconfig.json
│   ├── nest-cli.json
│   └── .env                       # 环境变量
├── docs/                          # 文档目录
│   ├── 需求文档.md
│   ├── 技术方案.md
│   └── API文档.md
└── README.md                      # 项目说明
```

## API接口设计

### 接口规范
- **基础URL**：`https://api.example.com/v1`
- **认证方式**：JWT Token
- **数据格式**：JSON
- **状态码**：RESTful标准

### 主要接口

#### 认证相关
```
POST /auth/login          # 管理员登录
POST /auth/wechat-login   # 微信小程序登录
POST /auth/refresh        # 刷新Token
```

#### 题目相关
```
GET    /questions         # 获取题目列表
GET    /questions/:id     # 获取题目详情
POST   /questions         # 创建题目
PUT    /questions/:id     # 更新题目
DELETE /questions/:id     # 删除题目
POST   /questions/:id/answer  # 提交答案
```

#### 视频相关
```
GET    /videos           # 获取视频列表
GET    /videos/:id       # 获取视频详情
POST   /videos           # 上传视频
PUT    /videos/:id       # 更新视频信息
DELETE /videos/:id       # 删除视频
POST   /videos/:id/progress  # 更新观看进度
```

#### 用户相关
```
GET /users/profile       # 获取用户信息
GET /users/records       # 获取学习记录
GET /users/statistics    # 获取学习统计
```

## 部署方案

### 开发环境
- **数据库**：本地MySQL
- **文件存储**：本地存储
- **后端服务**：本地Node.js服务
- **前端调试**：微信开发者工具 + 本地Web服务

### 生产环境
- **服务器**：云服务器（阿里云/腾讯云）
- **数据库**：云数据库MySQL
- **文件存储**：对象存储服务（OSS）
- **域名**：HTTPS域名（小程序要求）
- **CDN**：静态资源加速

### 部署流程
1. 后端服务部署到云服务器
   - 安装Node.js和PM2
   - 执行 `npm run build` 构建NestJS应用
   - 配置环境变量
2. 数据库初始化和数据迁移
   - 执行 `npx prisma migrate deploy`
   - 执行 `npx prisma generate`
3. 配置文件存储服务
4. PC管理后台构建和部署
5. 微信小程序提交审核

## 安全方案

### 数据安全
- 数据库连接加密
- 敏感数据字段加密存储
- SQL注入防护
- XSS攻击防护

### 接口安全
- JWT Token认证
- 接口访问频率限制
- 参数验证和过滤
- HTTPS强制使用

### 文件安全
- 文件类型验证
- 文件大小限制
- 恶意文件扫描
- 访问权限控制

## 性能优化

### 前端优化
- **小程序端**：
  - 图片懒加载
  - 分包加载
  - 本地缓存策略
  - 网络请求优化

- **PC管理端**：
  - 路由懒加载
  - 组件按需加载
  - 静态资源压缩
  - CDN加速

### 后端优化
- 数据库索引优化
- 接口响应缓存
- 分页查询
- 文件压缩和CDN

### 数据库优化
- 索引优化
- 查询优化
- 连接池配置
- 读写分离（后期）

## 开发计划

### 第一阶段（2周）
- 项目初始化和环境搭建
- Prisma Schema设计和数据库迁移
- NestJS基础模块搭建（认证、用户模块）
- 微信小程序基础页面搭建

### 第二阶段（3周）
- 后端API开发完成
- 微信小程序功能开发
- PC管理后台开发

### 第三阶段（1周）
- 功能测试和联调
- 性能优化
- 部署上线

## 风险评估

### 技术风险
- 微信小程序平台限制
- 视频播放兼容性问题
- 文件上传大小限制

### 解决方案
- 严格按照微信小程序开发规范
- 使用标准视频格式和编码
- 实现分片上传功能

---

**文档版本**：v1.0  
**创建日期**：2025年9月28日  
**最后更新**：2025年9月28日
