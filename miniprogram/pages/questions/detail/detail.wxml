<!--pages/questions/detail/detail.wxml-->
<wxs module="utils">
  // è·å–é€‰é¡¹æ ‡ç­¾ï¼ˆAã€Bã€Cã€D...ï¼‰
  var getOptionLabel = function(index) {
    var labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
    return labels[index] || '';
  };

  // æ£€æŸ¥æ•°ç»„æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ 
  var includes = function(arr, item) {
    for (var i = 0; i < arr.length; i++) {
      if (arr[i] === item) {
        return true;
      }
    }
    return false;
  };

  module.exports = {
    getOptionLabel: getOptionLabel,
    includes: includes
  };
</wxs>

<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="detail-content">
    <!-- æ”¶è—æŒ‰é’® -->
    <view class="favorite-btn" bindtap="toggleFavorite">
      <text class="favorite-icon {{isFavorite ? 'favorited' : ''}}">{{isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
    </view>

    <!-- é¢˜ç›®ä¿¡æ¯ -->
    <view class="question-card card">
      <view class="question-header">
        <text class="question-title">{{question.title}}</text>
        <view class="tags">
          <view class="tag tag-{{question.difficulty === 'easy' ? 'success' : question.difficulty === 'medium' ? 'warning' : 'danger'}}">
            {{question.difficulty === 'easy' ? 'ç®€å•' : question.difficulty === 'medium' ? 'ä¸­ç­‰' : 'å›°éš¾'}}
          </view>
          <view class="tag tag-primary">{{question.category}}</view>
        </view>
      </view>

      <view class="question-type">
        <text>{{question.type === 'single' ? 'ğŸ“ å•é€‰é¢˜' : question.type === 'multiple' ? 'âœ… å¤šé€‰é¢˜' : 'â“ åˆ¤æ–­é¢˜'}}</text>
      </view>

      <view class="question-content">
        <text>{{question.content}}</text>
      </view>

      <!-- é€‰é¡¹åˆ—è¡¨ -->
      <view class="options-list" wx:if="{{question.options && question.options.length > 0}}">
        <view 
          class="option-item {{utils.includes(selectedAnswers, utils.getOptionLabel(index)) ? 'selected' : ''}} {{submitted && utils.includes(correctAnswer, utils.getOptionLabel(index)) ? 'correct' : ''}} {{submitted && utils.includes(selectedAnswers, utils.getOptionLabel(index)) && !utils.includes(correctAnswer, utils.getOptionLabel(index)) ? 'wrong' : ''}}"
          wx:for="{{question.options}}"
          wx:key="*this"
          bindtap="selectOption"
          data-option="{{item}}"
          data-index="{{index}}"
        >
          <view class="option-label">{{utils.getOptionLabel(index)}}</view>
          <view class="option-content">{{item}}</view>
          <view class="option-icon" wx:if="{{submitted}}">
            <text wx:if="{{utils.includes(correctAnswer, utils.getOptionLabel(index))}}">âœ“</text>
            <text wx:elif="{{utils.includes(selectedAnswers, utils.getOptionLabel(index))}}">âœ—</text>
          </view>
        </view>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <view class="submit-btn" wx:if="{{!submitted}}">
        <button class="btn btn-primary" bindtap="submitAnswer" disabled="{{selectedAnswers.length === 0}}">
          æäº¤ç­”æ¡ˆ
        </button>
      </view>

      <!-- ç­”æ¡ˆè§£æ -->
      <view class="answer-section" wx:if="{{submitted}}">
        <view class="answer-result {{isCorrect ? 'correct' : 'wrong'}}">
          <text class="result-icon">{{isCorrect ? 'âœ“' : 'âœ—'}}</text>
          <text class="result-text">{{isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯'}}</text>
        </view>

        <view class="correct-answer">
          <text class="label">æ­£ç¡®ç­”æ¡ˆï¼š</text>
          <text class="value">{{question.answer}}</text>
        </view>

        <view class="explanation" wx:if="{{question.explanation}}">
          <text class="label">ç­”æ¡ˆè§£æï¼š</text>
          <text class="content">{{question.explanation}}</text>
        </view>

        <!-- è§†é¢‘è®²è§£ -->
        <view class="video-section" wx:if="{{question.videoUrl}}">
          <text class="label">è§†é¢‘è®²è§£ï¼š</text>
          <video 
            id="questionVideo"
            class="video-player" 
            src="{{question.videoUrl}}" 
            poster="{{question.imageUrl || ''}}"
            controls
            show-center-play-btn="{{true}}"
            show-fullscreen-btn="{{true}}"
            show-play-btn="{{true}}"
            enable-play-gesture="{{true}}"
            object-fit="contain"
            direction="0"
            binderror="onVideoError"
            bindplay="onVideoPlay"
            bindpause="onVideoPause"
          ></video>
        </view>

        <!-- é‡æ–°ç­”é¢˜ -->
        <view class="retry-btn">
          <button class="btn btn-primary" bindtap="retryQuestion">å†åšä¸€æ¬¡</button>
        </view>
      </view>
    </view>
  </view>
</view>

